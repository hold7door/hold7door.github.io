<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Implementing domain based Multi-tenancy - 2 - Arpit Pathak</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Implementing domain based Multi-tenancy - 2">
<meta itemprop=description content="This is a tutorial on implementing a domain based multi-tenant application using NextJs and Openresty."><meta itemprop=datePublished content="2022-06-05T00:01:58+05:30">
<meta itemprop=dateModified content="2022-06-05T00:01:58+05:30">
<meta itemprop=wordCount content="1433">
<meta itemprop=keywords content="multi-tenant,nextjs,openresty,"><meta property="og:title" content="Implementing domain based Multi-tenancy - 2">
<meta property="og:description" content="This is a tutorial on implementing a domain based multi-tenant application using NextJs and Openresty.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://hold7door.github.io/posts/post-4/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-06-05T00:01:58+05:30">
<meta property="article:modified_time" content="2022-06-05T00:01:58+05:30">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Implementing domain based Multi-tenancy - 2">
<meta name=twitter:description content="This is a tutorial on implementing a domain based multi-tenant application using NextJs and Openresty.">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://hold7door.github.io/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://hold7door.github.io/css/main.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://hold7door.github.io/css/dark.css>
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://hold7door.github.io/js/main.js></script>
</head>
<body>
<div class="container wrapper">
<div class=header>
<div class=avatar>
<a href=https://hold7door.github.io/>
<img src="https://avatars.githubusercontent.com/u/19802812?s=400&u=0d6989dc1f17ce997358a47dcd777cdb3bdc8b52&v=4" alt="Arpit Pathak">
</a>
</div>
<h1 class=site-title><a href=https://hold7door.github.io/>Arpit Pathak</a></h1>
<div class=site-description><p>Thinking | Learning | Coding | Sharing</p><nav class="nav social">
<ul class=flat><li><a href=https://github.com/hold7door title=Github><i data-feather=github></i></a></li><li><a href=https://twitter.com/AP_zahlen title=Twitter><i data-feather=twitter></i></a></li><li><a href=https://www.linkedin.com/in/arpit-pathak title=LinkedIn><i data-feather=linkedin></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/posts>Blog</a>
</li>
<li>
<a href=/about>About</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
</ul>
</nav>
</div>
<div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>05</span>
<span class=rest>Jun 2022</span>
</div>
</div>
<div class=matter>
<h1 class=title>Implementing domain based Multi-tenancy - 2</h1>
</div>
</div>
<div class=markdown>
<p>In the previous post I showed you how to set up a NextJs application to serve pages based on users custom domain.</p>
<p><strong><em>If you haven&rsquo;t read the previous article follow here for <a href=https://hold7door.github.io/posts/post-3/>Part 1</a>. Otherwise please continue reading</em></strong></p>
<p>The main problem now remains is to dynamically provision HTTPS certificates for the newly created domains so that data can be served over TLS. For this we use <em>Openresty</em> which is wrapper around Nginx and provides inbuilt support for <em>Lua</em> programming language.</p>
<p>Using openresty+Lua and other supporting modules we can create SSL certificates on demand from LetsEncrypt.</p>
<h3 id=setting-up-openresty>Setting up Openresty</h3>
<h4 id=step-1>Step 1</h4>
<p>If you have an existing installation of Nginx running we need to remove it first. Otherwise please move to Step 2.</p>
<p><em>Warning: Please backup all your configuration files</em>.</p>
<p>To remove nginx -</p>
<ol>
<li>First make sure you have made a backup of your nginx configuration files</li>
<li>Run the following commands to delete nginx and its related binaries</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># sudo systemctl stop nginx.service
# sudo systemctl disable nginx.service
# sudo userdel -r nginx
# sudo rm -rf /etc/nginx
# sudo rm -rf /var/log/nginx
# sudo rm -rf /var/cache/nginx/
# sudo rm -rf /usr/lib/systemd/system/nginx.service
</code></pre></div><h4 id=step-2>Step 2</h4>
<p>Now Install openresty:</p>
<p>Prerequisites for installing Openresty:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&gt; Debian and Ubuntu users

You&#39;re recommended to install the following packages using apt-get:

$ apt-get install libpcre3-dev \
    libssl-dev perl make build-essential curl

&gt; Fedora and RedHat users

You&#39;re recommended to install the following packages using yum:

$ yum install pcre-devel openssl-devel gcc curl

</code></pre></div><p>This page from DigitalOcean does a good job on instructing how you can download and install Openresty -</p>
<p><a href=https://www.digitalocean.com/community/tutorials/how-to-use-the-openresty-web-framework-for-nginx-on-ubuntu-16-04>https://www.digitalocean.com/community/tutorials/how-to-use-the-openresty-web-framework-for-nginx-on-ubuntu-16-04</a></p>
<p><strong>Important: If you followed the above link, there are a few caveats that you need to take care of</strong></p>
<ol>
<li>We need to build openresty with http2. So the command to configure and build should be: <code>./configure -j2 --with-pcre-jit --with-ipv6 --with-http_v2_module</code>. If its a success the output should be something like (check the paths to the nginx files and binaries)</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>nginx path prefix: &#34;/usr/local/openresty/nginx&#34;
nginx binary file: &#34;/usr/local/openresty/nginx/sbin/nginx&#34;
nginx modules path: &#34;/usr/local/openresty/nginx/modules&#34;
nginx configuration prefix: &#34;/usr/local/openresty/nginx/conf&#34;
nginx configuration file: &#34;/usr/local/openresty/nginx/conf/nginx.conf&#34;
nginx pid file: &#34;/usr/local/openresty/nginx/logs/nginx.pid&#34;
nginx error log file: &#34;/usr/local/openresty/nginx/logs/error.log&#34;
nginx http access log file: &#34;/usr/local/openresty/nginx/logs/access.log&#34;
nginx http client request body temporary files: &#34;client_body_temp&#34;
nginx http proxy temporary files: &#34;proxy_temp&#34;
nginx http fastcgi temporary files: &#34;fastcgi_temp&#34;
nginx http uwsgi temporary files: &#34;uwsgi_temp&#34;
nginx http scgi temporary files: &#34;scgi_temp&#34;

</code></pre></div><ol start=2>
<li>
<p>When setting up OpenResty as a Servie on <em>AWS AMI</em> the <code>openresty.service</code> file should be created in <code>/usr/lib/systemd/system</code></p>
</li>
<li>
<p>Openresty should run as <em>www-data</em> user. Create user www-data if it does not exists using the following command</p>
</li>
</ol>
<p><code>$ sudo adduser --system --no-create-home --shell /bin/false --user-group www-data</code></p>
<p>OpenResty workers should run as this user, so inside the nginx.conf file make sure you have this line</p>
<p><code>user: www-data</code></p>
<ol start=4>
<li>Create the directory <em>/var/log/openresty</em> and make sure that inside the nginx.conf file this directory is set as the target for log files</li>
</ol>
<p>Great! Now we have Openresty up and running. Now let&rsquo;s get to the good part and see how we can use the inbuilt Lua integration of Openresty for dynamically creating SSL certificates for custom domains.</p>
<h3 id=installing-luarocks-and-lua-resty-auto-ssl>Installing LuaRocks and lua-resty-auto-ssl</h3>
<p>The <a href=https://github.com/fffonion/lua-resty-openssl>lua-resty-auto-ssl</a> plugin for OpenResty mentions itself as a -</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback> On the fly (and free) SSL registration and renewal inside OpenResty/nginx with Let&#39;s Encrypt.
</code></pre></div><p>This OpenResty plugin automatically and transparently issues SSL certificates from Let&rsquo;s Encrypt (a free certificate authority) as requests are received. It works like:</p>
<ul>
<li>A SSL request for a SNI hostname is received.</li>
<li>If the system already has a SSL certificate for that domain, it is immediately returned (with OCSP stapling).</li>
<li>If the system does not yet have an SSL certificate for this domain, it issues a new SSL certificate from Let&rsquo;s Encrypt. Domain validation is handled for you. After receiving the new certificate (usually within a few seconds), the new certificate is saved, cached, and returned to the client (without dropping the original request).</li>
</ul>
<p>To install <em>lua-resty-auto-ssl</em> plugin we first need to install <em>LuaRocks package manager</em>. For this we execute the following commands:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ sudo apt install build-essential libreadline-dev unzip

$ wget https://luarocks.org/releases/luarocks-3.8.0.tar.gz

$ tar zxpf luarocks-3.8.0.tar.gz

$ cd luarocks-3.8.0

# Note that in this command line separators are important

$ ./configure --prefix=/usr/local/openresty/luajit \

 --lua-suffix=jit \

 --with-lua-include=/usr/local/openresty/luajit/include/luajit-2.1 \

--with-lua=/usr/local/openresty/luajit/

$ sudo ln -s /usr/local/openresty/luajit/bin/luarocks /usr/bin/luarocks

</code></pre></div><p>Now that we have LuaRocks installed we can use it to install the <em>lua-resty-auto-ssl</em> plugin:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ sudo luarocks install lua-resty-auto-ssl

$ sudo mkdir /etc/resty-auto-ssl

$ sudo chown www-data /etc/resty-auto-ssl

</code></pre></div><p>Cool! Now the final part remaining is to see how we can set up our nginx configuration to use this plugin to provision certificates.</p>
<h3 id=configuring-the-web-server>Configuring the Web Server</h3>
<p>Inside the <code>http</code> block of our nginx.conf file we need to have the following lines -</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>http {
    # Conf for lua-auto-ssl
    # The &#34;auto_ssl&#34; shared dict should be defined with enough storage space to
    # hold your certificate data. 1MB of storage holds certificates for
    # approximately 100 separate domains.
    lua_shared_dict auto_ssl 2m;

    # The &#34;auto_ssl_settings&#34; shared dict is used to temporarily store various settings
    # like the secret used by the hook server on port 8999. Do not change or
    # omit it.
    lua_shared_dict auto_ssl_settings 64k;

    # A DNS resolver must be defined for OCSP stapling to function.
    #
    # This example uses Google&#39;s DNS server. You may want to use your system&#39;s
    # default DNS servers, which can be found in /etc/resolv.conf. If your network
    # is not IPv6 compatible, you may wish to disable IPv6 results by using the
    # &#34;ipv6=off&#34; flag (like &#34;resolver 8.8.8.8 ipv6=off&#34;).
    resolver 8.8.8.8;

    # Initial setup tasks.
    init_by_lua_block {
        auto_ssl = (require &#34;resty.auto-ssl&#34;).new()
        -- Define a function to determine which SNI domains to automatically handle
        -- and register new certificates for. Defaults to not allowing any domains,
        -- so this must be configured.
        auto_ssl:set(&#34;allow_domain&#34;, function(domain)
            -- ngx.log(ngx.STDERR, domain)
            -- Return false of restricted domains and IP address

            if string.find(domain, &#34;www.example.com&#34;) then
                    return false
            end

            local http = require(&#34;resty.http&#34;)
            local httpc = http.new()
            httpc:set_timeout(3000)

            -- Make a API call to your web server for some custom logic to check whether to issue certificate for this domain or not
            local uri = &#34;https://api.example.com/check-domain/&#34; .. domain
            local res, err = httpc:request_uri(uri, {
                    ssl_verify = false,
                    method = &#34;GET&#34;
            })

            if not res then
                    return false
            end

            if res.status == 200 then
                    return true
            else
                    return false
            end

        end)

        -- This line should be present during development otherwise your account may hit rate limiting issues

        auto_ssl:set(&#34;ca&#34;, &#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;)

        -- All certificates will be checked for renewal every 12 hrs
        -- Renewal happens if certificate expires in less than 30 days

        auto_ssl:set(&#34;renew_check_interval&#34;, 43200)

        auto_ssl:init()
    }

    init_worker_by_lua_block {
            auto_ssl:init_worker()
    }

    # Internal server running on port 8999 for handling certificate tasks.
    server {
    listen 127.0.0.1:8999;

    # Increase the body buffer size, to ensure the internal POSTs can always
    # parse the full POST contents into memory.
    client_body_buffer_size 128k;
    client_max_body_size 128k;

    location / {
        content_by_lua_block {
        auto_ssl:hook_server()
        }
    }
    }

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include conf.d/*.conf;
}
</code></pre></div><p>Note that we don&rsquo;t want to provision certificate for our own domain. Notice that we have done this for <a href=http://www.example.com>www.example.com</a> which for example let&rsquo;s say is our own domain.</p>
<p>We also need to have a path in our configuration listening on port 80 for the ACME challenge from LetsEncrypt. So we need to set up a location block for this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># Endpoint used for performing domain verification with Let&#39;s Encrypt.
location /.well-known/acme-challenge/ {
  content_by_lua_block {
    auto_ssl:challenge_server()
  }
}
</code></pre></div><p>And lastly but not the least, we also need to have a location block to proxy pass request to our NextJS application.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># NextJS to serve custom domain
location / {
    proxy_pass http://localhost:3000;
    proxy_set_header Host $host;
}
</code></pre></div><h3 id=conclusion>Conclusion</h3>
<p>Now any user who wants to map their custom domain to our application can add an <strong>A record</strong> and point it to our servers IP (which we need to provide them).</p>
<p>If SSL cert doesn&rsquo;t exist for a domain, it&rsquo;s generated and served automatically when you request the URL for the first time. Naturally, there is a latency of ~10s for the very first request. Next time onwards it&rsquo;s blazing fast since the certs are cached. Since LE certs are valid for 90 days, renewals happen automatically if the expiry date is &lt; 30 days.</p>
<p>Some follow ups you might have like -</p>
<ol>
<li>How to map CNAME ?</li>
<li>What to do in the case where we have multiple servers distributed accross the globe?</li>
</ol>
<p>Connect with me on twitter where I&rsquo;ll answer all queries. If needed I&rsquo;ll write another blog post about it in the future.</p>
<p>Hope you liked it, See you in the next blog :)</p>
</div>
<div class=tags>
<ul class=flat>
<li><a href=/tags/multi-tenant>multi-tenant</a></li>
<li><a href=/tags/nextjs>nextjs</a></li>
<li><a href=/tags/openresty>openresty</a></li>
</ul>
</div><div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='ink-demo',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div>2024 © Copyright notice | Powered by <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>